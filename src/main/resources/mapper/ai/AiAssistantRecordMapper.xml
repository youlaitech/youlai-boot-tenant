<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youlai.boot.platform.ai.mapper.AiAssistantRecordMapper">

  <resultMap id="AiAssistantRecordResultMap" type="com.youlai.boot.platform.ai.model.vo.AiAssistantRecordVO">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="username" column="username"/>
    <result property="originalCommand" column="original_command"/>
    <result property="aiProvider" column="ai_provider"/>
    <result property="aiModel" column="ai_model"/>
    <result property="parseStatus" column="parse_status"/>
    <result property="functionCalls" column="function_calls"/>
    <result property="explanation" column="explanation"/>
    <result property="confidence" column="confidence"/>
    <result property="parseErrorMessage" column="parse_error_message"/>
    <result property="inputTokens" column="input_tokens"/>
    <result property="outputTokens" column="output_tokens"/>
    <result property="parseDurationMs" column="parse_duration_ms"/>
    <result property="functionName" column="function_name"/>
    <result property="functionArguments" column="function_arguments"/>
    <result property="executeStatus" column="execute_status"/>
    <result property="executeErrorMessage" column="execute_error_message"/>
    <result property="ipAddress" column="ip_address"/>
    <result property="createTime" column="create_time"/>
    <result property="updateTime" column="update_time"/>
  </resultMap>

  <select id="getRecordPage" resultMap="AiAssistantRecordResultMap">
    SELECT
      aar.id,
      aar.user_id,
      aar.username,
      aar.original_command,
      aar.ai_provider,
      aar.ai_model,
      aar.parse_status,
      aar.function_calls,
      aar.explanation,
      aar.confidence,
      aar.parse_error_message,
      aar.input_tokens,
      aar.output_tokens,
      aar.parse_duration_ms,
      aar.function_name,
      aar.function_arguments,
      aar.execute_status,
      aar.execute_error_message,
      aar.ip_address,
      aar.create_time,
      aar.update_time
    FROM ai_assistant_record aar
    <where>
      <if test="queryParams.keywords != null and queryParams.keywords != ''">
        (
          aar.original_command LIKE CONCAT('%', #{queryParams.keywords}, '%')
          OR aar.function_name LIKE CONCAT('%', #{queryParams.keywords}, '%')
          OR aar.username LIKE CONCAT('%', #{queryParams.keywords}, '%')
        )
      </if>
      <if test="queryParams.executeStatus != null">
        AND aar.execute_status = #{queryParams.executeStatus}
      </if>
      <if test="queryParams.userId != null">
        AND aar.user_id = #{queryParams.userId}
      </if>
      <if test="queryParams.parseStatus != null">
        AND aar.parse_status = #{queryParams.parseStatus}
      </if>
      <if test="queryParams.functionName != null and queryParams.functionName != ''">
        AND aar.function_name = #{queryParams.functionName}
      </if>
      <if test="queryParams.aiProvider != null and queryParams.aiProvider != ''">
        AND aar.ai_provider = #{queryParams.aiProvider}
      </if>
      <if test="queryParams.aiModel != null and queryParams.aiModel != ''">
        AND aar.ai_model = #{queryParams.aiModel}
      </if>
      <if test="
        queryParams.createTime != null
        and queryParams.createTime.size() == 2
        and queryParams.createTime[0] != null
        and queryParams.createTime[0] != ''
        and queryParams.createTime[1] != null
        and queryParams.createTime[1] != ''
      ">
        AND aar.create_time BETWEEN #{queryParams.createTime[0]} AND #{queryParams.createTime[1]}
      </if>
    </where>
    ORDER BY aar.create_time DESC
  </select>

</mapper>
