<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youlai.boot.platform.ai.mapper.AiCommandRecordMapper">

  <resultMap id="AiCommandRecordResultMap" type="com.youlai.boot.platform.ai.model.vo.AiCommandRecordVO">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="username" column="username"/>
    <result property="originalCommand" column="original_command"/>
    <result property="aiProvider" column="ai_provider"/>
    <result property="aiModel" column="ai_model"/>
    <result property="parseStatus" column="parse_status"/>
    <result property="functionCalls" column="function_calls"/>
    <result property="explanation" column="explanation"/>
    <result property="confidence" column="confidence"/>
    <result property="parseErrorMessage" column="parse_error_message"/>
    <result property="inputTokens" column="input_tokens"/>
    <result property="outputTokens" column="output_tokens"/>
    <result property="parseDurationMs" column="parse_duration_ms"/>
    <result property="functionName" column="function_name"/>
    <result property="functionArguments" column="function_arguments"/>
    <result property="executeStatus" column="execute_status"/>
    <result property="executeErrorMessage" column="execute_error_message"/>
    <result property="ipAddress" column="ip_address"/>
    <result property="createTime" column="create_time"/>
    <result property="updateTime" column="update_time"/>
  </resultMap>

  <select id="getRecordPage" resultMap="AiCommandRecordResultMap">
    SELECT
      acr.id,
      acr.user_id,
      acr.username,
      acr.original_command,
      acr.ai_provider,
      acr.ai_model,
      acr.parse_status,
      acr.function_calls,
      acr.explanation,
      acr.confidence,
      acr.parse_error_message,
      acr.input_tokens,
      acr.output_tokens,
      acr.parse_duration_ms,
      acr.function_name,
      acr.function_arguments,
      acr.execute_status,
      acr.execute_error_message,
      acr.ip_address,
      acr.create_time,
      acr.update_time
    FROM ai_command_record acr
    <where>
      <if test="queryParams.keywords != null and queryParams.keywords != ''">
        (
          acr.original_command LIKE CONCAT('%', #{queryParams.keywords}, '%')
          OR acr.function_name LIKE CONCAT('%', #{queryParams.keywords}, '%')
          OR acr.username LIKE CONCAT('%', #{queryParams.keywords}, '%')
        )
      </if>
      <if test="queryParams.executeStatus != null">
        AND acr.execute_status = #{queryParams.executeStatus}
      </if>
      <if test="queryParams.userId != null">
        AND acr.user_id = #{queryParams.userId}
      </if>
      <if test="queryParams.parseStatus != null">
        AND acr.parse_status = #{queryParams.parseStatus}
      </if>
      <if test="queryParams.functionName != null and queryParams.functionName != ''">
        AND acr.function_name = #{queryParams.functionName}
      </if>
      <if test="queryParams.aiProvider != null and queryParams.aiProvider != ''">
        AND acr.ai_provider = #{queryParams.aiProvider}
      </if>
      <if test="queryParams.aiModel != null and queryParams.aiModel != ''">
        AND acr.ai_model = #{queryParams.aiModel}
      </if>
      <if test="
        queryParams.createTime != null
        and queryParams.createTime.size() == 2
        and queryParams.createTime[0] != null
        and queryParams.createTime[0] != ''
        and queryParams.createTime[1] != null
        and queryParams.createTime[1] != ''
      ">
        AND acr.create_time BETWEEN #{queryParams.createTime[0]} AND #{queryParams.createTime[1]}
      </if>
    </where>
    ORDER BY acr.create_time DESC
  </select>

</mapper>


